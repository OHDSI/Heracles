/*! Heracles 2015-02-02 */
function translateJsonDataToArray(a){var b={};return b.array=[],b.keys=[],b.values=[],$.each(a,function(a,c){b.keys.push(a),b.values.push(c);var d={};d.label=a,d.value=c,b.array.push(d)}),b}function getCurrentMaxHeight(){return($("#cohort-explorer-summary").height()+hiddenDivHeight)/2-50}function showAgeDistribution(a){var b=translateJsonDataToArray(a);$("#age_dist").empty();var c=Math.max(getCurrentMaxHeight(),150),d=c/2,e=d3.scale.ordinal().domain(b.keys).range(colorRange),f=d3.select("#age_dist").append("svg:svg").data([b.array]).attr("width",c).attr("height",c).append("svg:g").attr("transform","translate("+d+","+d+")"),g=d3.layout.pie().value(function(a){return a.value}),h=d3.svg.arc().outerRadius(d),i=f.selectAll("g.slice").data(g).enter().append("svg:g").attr("class","slice");i.append("svg:path").attr("fill",function(a,b){return e(b)}).attr("d",function(a){return h(a)}),i.append("svg:text").attr("transform",function(a){return a.innerRadius=0,a.outerRadius=d,"translate("+h.centroid(a)+")"}).attr("text-anchor","middle").attr("fill","white").text(function(a,c){return b.array[c].label}),i.append("svg:text").attr("transform",function(a){a.innerRadius=0,a.outerRadius=d;var b=h.centroid(a);return b[1]+=20,"translate("+b+")"}).attr("text-anchor","middle").attr("fill","white").attr("font-weight","bold").text(function(a,c){return b.array[c].value+"%"})}function showGenderDistribution(a){var b=translateJsonDataToArray(a),c=b.array,d=d3.scale.ordinal().domain(b.keys).range(colorRange);$("#gender_dist").empty();var e=60,f=(e+10)*c.length,g=Math.max(getCurrentMaxHeight(),150),h=d3.scale.linear().domain([0,c.length]).range([0,f]),i=d3.scale.linear().domain([0,d3.max(c,function(a){return a.value})]).rangeRound([0,g]),j=d3.select("#gender_dist").append("svg:svg").attr("width",f).attr("height",g);j.selectAll("rect").data(c).enter().append("svg:rect").attr("x",function(a,b){return h(b)}).attr("y",function(a){return g-i(a.value)}).attr("height",function(a){return i(a.value)}).attr("width",e).attr("fill",function(a,b){return d(b)}),j.selectAll("text").data(c).enter().append("svg:text").attr("x",function(a,b){return h(b)+e}).attr("y",function(a){return g-i(a.value)}).attr("dx",-e/2).attr("dy","1.2em").attr("text-anchor","middle").attr("font-weight","bold").text(function(a){return a.value+"%"}).attr("fill","white"),j.selectAll("text.yAxis").data(c).enter().append("svg:text").attr("x",function(a,b){return h(b)+e}).attr("y",g).attr("dx",-e/2).attr("text-anchor","middle").attr("style","font-size: 12; font-family: Helvetica, sans-serif").attr("fill","white").text(function(a){return a.label}).attr("transform","translate(0, -4)").attr("class","yAxis")}function type(a){return a.value=+a.value,a}function isDemoMode(){return"true"===$("#demo-mode").val()}function toggleVisibleReports(a,b){$(b).find("input[type='checkbox']:visible").prop("checked",a)}function split(a){return a.split(/,\s*/)}!function(){angular.module("Heracles",[]).controller("CohortExplorerCtrl",function(a,b){a.showCohort=function(){b.get("/data/sample-cohort-explorer.json").then(function(b){b.data.completed_cohorts={},b.data.new_cohorts={},$.each(b.data.analyses,function(){this.done===!0?(b.data.completed_cohorts[this.category]||(b.data.completed_cohorts[this.category]=[]),b.data.completed_cohorts[this.category].push(this)):(b.data.new_cohorts[this.category]||(b.data.new_cohorts[this.category]=[]),b.data.new_cohorts[this.category].push(this))}),a.cohort=b.data,showAgeDistribution(b.data.age_distribution),showGenderDistribution(b.data.gender_distribution)})}})}();var colorRange=["#AF0C3C","#290F2E","#0E7184","#F0D31A","#FE7D0D"],hiddenDivHeight=250,activeFilter;jQuery.fn.filterByText=function(a){return this.each(function(){var b=this;$(a).bind("change keyup",function(){var a=$(this).val().trim(),c=new RegExp(a,"gi"),d=[];$(b).find("label").each(function(){var a=$(this),b=a.find("input").attr("value");if(b&&null!==b.match(c)){a.show();var e=a.find("input").attr("parent");e&&d.indexOf(e)<0&&d.push(e)}else a.hide()}),$.each(d,function(){$(".toggle-parent-label[key='"+this+"']").show()})})})},jQuery.fn.multiselect=function(){$(this).each(function(){var a=$(this).find(".toggle-checkbox-item");a.each(function(){var a=$(this);a.attr("checked")&&a.parent().addClass("multiselect-on"),a.click(function(){a.attr("checked")?a.parent().addClass("multiselect-on"):a.parent().removeClass("multiselect-on")})})})},$(document).ready(function(){var a;a=isDemoMode()?"/data/sample-cohorts.json":getWebApiUrl()+"/cohortdefinition";var b=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("COHORT_DEFINITION_NAME"),queryTokenizer:Bloodhound.tokenizers.whitespace,limit:10,prefetch:a});b.initialize(),$("body").tooltip({selector:"[data-toggle=tooltip]"}),$("#cohorts-typeahead .typeahead").typeahead({hint:!0,highlight:!0,minLength:1},{name:"cohorts",displayKey:"value",source:b.ttAdapter(),templates:{empty:['<div class="empty-message">',"Unable to find any cohorts that match the current query","</div>"].join("\n"),suggestion:Handlebars.compile("<p><strong>{{COHORT_DEFINITION_NAME}}</strong> â€“ {{COHORT_DEFINITION_DESCRIPTION}}</p>")}}),$("#cohorts-typeahead").bind("typeahead:selected",function(a,b){$("#cohorts").val(b.cohortDefinitionName),$(".page-one").slideUp("fast",function(){angular.element($("#cohort-explorer-main")).scope().showCohort(b),$("#cohort-explorer-main").slideDown("slow")})}),$("#cohort-explorer-back").click(function(){$("#cohort-explorer-main").slideUp("fast",function(){$(".page-one").slideDown("fast",function(){setTimeout(function(){$("#cohorts-typeahead").focus()},3e3)})})}),$(".auto-filter-check-list-select").click(function(){return toggleVisibleReports(!0,".multiselect[filter-key='"+$(this).attr("filter-key")+"']"),!1}),$(".auto-filter-check-list-clear").click(function(){return toggleVisibleReports(!1,".multiselect[filter-key='"+$(this).attr("filter-key")+"']"),!1}),$(".toggle-parent-label").click(function(){var a=$(this).prop("checked");$("input[parent='"+$(this).val()+"']:visible").prop("checked",a)}),$(".auto-filter-check-list-input").focus(function(){activeFilter=$(this).attr("filter-key"),$(".multiselect-wrapper[filter-key!='"+activeFilter+"']:visible").slideUp("slow"),$(".multiselect-wrapper[filter-key='"+activeFilter+"']").slideDown("slow")}),$("body").click(function(a){var b=!0,c=$(a.target);c.attr("filter-key")&&c.attr("filter-key")===activeFilter&&(b=!1);var d=c.parents(".multiselect-wrapper").attr("filter-key");d&&d===activeFilter&&(b=!1),b&&activeFilter&&($(".multiselect-wrapper[filter-key='"+activeFilter+"']").slideUp("slow"),activeFilter=void 0)}),setTimeout(function(){$("#cohorts-typeahead").focus()},3e3)}),$(function(){$(".multiselect").multiselect()}),$(function(){$(".multiselect").each(function(){var a=$(this).attr("filter-key");$(this).filterByText($(".auto-filter-check-list-input[filter-key='"+a+"']"),!0)})});